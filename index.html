<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Keyboard Research</title>

<style>
body {
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #f2f2f2;
  font-family: sans-serif;
}

#textArea {
  flex: 1;
  font-size: 20px;
  padding: 10px;
}

#topBar {
  display: flex;
  justify-content: center;
  padding: 8px;
  background: #ddd;
}

button {
  font-size: 16px;
  padding: 6px 12px;
}

#keyboard {
  position: relative;
  height: 45vh;
  background: #ccc;
  touch-action: none;
}

.key {
  position: absolute;
  background: white;
  border-radius: 10px;
  border: 1px solid #888;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  user-select: none;
  touch-action: none;
}
</style>
</head>

<body>

<textarea id="textArea" placeholder="ここに入力されます"></textarea>

<div id="topBar">
  <button id="modeBtn">編集モード</button>
</div>

<div id="keyboard"></div>

<script>
/* ===== モード ===== */
let editMode = true;

/* ===== ローマ字バッファ ===== */
let romajiBuffer = "";

/* ===== 記号用 ===== */
const symbolList = ["、", "。", "ー", "！", "？"];
let symbolIndex = 0;

let symbolTimer = null;
const SYMBOL_RESET_TIME = 500;
let symbolActive = false;



/* ===== キー配置（backspace追加） ===== */
const keys = [
   { label:"a", x:10, y:20, w:52, h:52 },
  { label:"i", x:70, y:20, w:52, h:52 },
  { label:"u", x:130, y:20, w:52, h:52 },
  { label:"e", x:190, y:20, w:52, h:52 },
  { label:"o", x:250, y:20, w:52, h:52 },
  { label:"k", x:310, y:20, w:52, h:52 },
  { label:"s", x:370, y:20, w:52, h:52 },

  { label:"t", x:10, y:90, w:52, h:52 },
  { label:"n", x:70, y:90, w:52, h:52 },
  { label:"h", x:130, y:90, w:52, h:52 },
  { label:"m", x:190, y:90, w:52, h:52 },
  { label:"y", x:250, y:90, w:52, h:52 },
  { label:"r", x:310, y:90, w:52, h:52 },
  { label:"w", x:370, y:90, w:52, h:52 },
  { label:"g", x:430, y:90, w:52, h:52 },

  { label:"z", x:40, y:160, w:52, h:52 },
  { label:"d", x:100, y:160, w:52, h:52 },
  { label:"b", x:290, y:160, w:52, h:52 },
  { label:"p", x:350, y:160, w:52, h:52 },

  { label:"symbol", x:410, y:160, w:70, h:52 },
  { label:"back", x:430, y:20, w:70, h:52 },
  { label:"space", x:160, y:160, w:120, h:52 }
];

const keyboard = document.getElementById("keyboard");
const textArea = document.getElementById("textArea");
const modeBtn = document.getElementById("modeBtn");

/* ===== ローマ字→かな ===== */
const kanaMap = {
  a:"あ", i:"い", u:"う", e:"え", o:"お",
  ka:"か", ki:"き", ku:"く", ke:"け", ko:"こ",
  sa:"さ", si:"し", shi:"し", su:"す", se:"せ", so:"そ",
  ta:"た", ti:"ち", tu:"つ", tsu:"つ", te:"て", to:"と",
  na:"な", ni:"に", nu:"ぬ", ne:"ね", no:"の",
  ha:"は", hi:"ひ", hu:"ふ", he:"へ", ho:"ほ",
  ma:"ま", mi:"み", mu:"む", me:"め", mo:"も",
  ya:"や", yu:"ゆ", yo:"よ", 
  ra:"ら", ri:"り", ru:"る", re:"れ", ro:"ろ",
  wa:"わ", wo:"を", nn:"ん",
  ga:"が", gi:"ぎ", gu:"ぐ", ge:"げ", go:"ご",
  za:"ざ", zi:"じ", zu:"ず", ze:"ぜ", zo:"ぞ",
  da:"だ", di:"ぢ", du:"づ", de:"で", do:"ど",
  ba:"ば", bi:"び", bu:"ぶ", be:"べ", bo:"ぼ",
  pa:"は", pi:"ひ", pu:"ふ", pe:"へ", po:"ほ",
  kya:"きゃ", kyu:"きゅ", kyo:"きょ",
  sya:"しゃ", syu:"しゅ", syo:"しょ",
  tya:"ちゃ", tyu:"ちゅ", tyo:"ちょ",
  nya:"にゃ", nyu:"にゅ", nyo:"にょ",
  hya:"ひゃ", hyu:"ひゅ", hyo:"ひょ",
  mya:"みゃ", myu:"みゅ", myo:"みょ",
  rya:"りゃ", ryu:"りゅ", ryo:"りょ",
  gya:"ぎゃ", gyu:"ぎゅ", gyo:"ぎょ",
  zya:"じゃ", zyu:"じゅ", zyo:"じょ",
  dya:"ぢゃ", dyu:"ぢゅ", dyo:"ぢょ",
  bya:"びゃ", byu:"びゅ", byo:"びょ",
  pya:"きゃ", pyu:"きゅ", pyo:"きょ",
};

/* ===== 入力処理 ===== */
function handleInput(ch){
  romajiBuffer += ch;

  for(let len=3; len>=1; len--){
    const part = romajiBuffer.slice(-len);
    if(kanaMap[part]){
      textArea.value += kanaMap[part];
      romajiBuffer = "";
      return;
    }
  }

  if(/nn$/.test(romajiBuffer)){
    textArea.value += "ん";
    romajiBuffer = "";
  }
}

/* ===== 記号入力 ===== */
function handleSymbol(){
  // タイマーをリセット
  if(symbolTimer){
    clearTimeout(symbolTimer);
  }

  // すでに記号入力中なら「直前の1文字」を削除
  if(symbolActive){
    textArea.value = textArea.value.slice(0, -1);
  }

  // 今回の記号を入れる
  textArea.value += symbolList[symbolIndex];

  symbolIndex = (symbolIndex + 1) % symbolList.length;
  symbolActive = true;

  // 一定時間後に確定（リセット）
  symbolTimer = setTimeout(()=>{
    symbolIndex = 0;
    symbolActive = false;
    symbolTimer = null;
  }, SYMBOL_RESET_TIME);
}



/* ===== backspace ===== */
function handleBackspace(){
  if(romajiBuffer.length > 0){
    romajiBuffer = romajiBuffer.slice(0, -1);
  }else{
    textArea.value = textArea.value.slice(0, -1);
  }
}

/* ===== 描画 ===== */
function render(){
  keyboard.innerHTML = "";

  keys.forEach(k=>{
    const el = document.createElement("div");
    el.className = "key";
    el.textContent =
      k.label==="space" ? "␣" :
      k.label==="back" ? "⌫" :
      k.label;

    el.style.left = k.x+"px";
    el.style.top = k.y+"px";
    el.style.width = k.w+"px";
    el.style.height = k.h+"px";

    /* 入力モード */
    el.addEventListener("click", ()=>{
      if(editMode) return;

      if(k.label==="space"){
        textArea.value += " ";
      }else if(k.label==="back"){
        handleBackspace();
      } else if(k.label==="symbol"){
        handleSymbol();
      }else{
        handleInput(k.label);
      }
    });

    /* 編集モード：移動＆サイズ */
    let sx, sy, startDist;

    el.addEventListener("touchstart", e=>{
      if(!editMode) return;

      if(e.touches.length===1){
        sx=e.touches[0].clientX;
        sy=e.touches[0].clientY;
      }

      if(e.touches.length===2){
        const dx=e.touches[0].clientX-e.touches[1].clientX;
        const dy=e.touches[0].clientY-e.touches[1].clientY;
        startDist=Math.hypot(dx,dy);
      }
    });

    el.addEventListener("touchmove", e=>{
      if(!editMode) return;
      e.preventDefault();

      if(e.touches.length===1){
        const nx=e.touches[0].clientX;
        const ny=e.touches[0].clientY;
        k.x+=nx-sx;
        k.y+=ny-sy;
        sx=nx; sy=ny;
        render();
      }

      if(e.touches.length===2 && startDist){
        const dx=e.touches[0].clientX-e.touches[1].clientX;
        const dy=e.touches[0].clientY-e.touches[1].clientY;
        const dist=Math.hypot(dx,dy);
        const scale=dist/startDist;
        k.w=Math.max(30,Math.min(120,k.w*scale));
        k.h=Math.max(30,Math.min(120,k.h*scale));
        startDist=dist;
        render();
      }
    });

    keyboard.appendChild(el);
  });
}

/* ===== モード切替 ===== */
modeBtn.onclick=()=>{
  editMode=!editMode;
  modeBtn.textContent=editMode?"編集モード":"入力モード";
};

/* 初期描画 */
render();
